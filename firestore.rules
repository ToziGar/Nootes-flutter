rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthed() { return request.auth != null; }
    function isOwner(uid) { return isAuthed() && request.auth.uid == uid; }

    // Public user profile search (limited fields)
    // For the app's share/search features, allow authenticated users to read user profiles.
    // Writes remain restricted to the document owner.
    match /users/{uid} {
      // Allow both single-doc gets and queries (list) for authed users
      allow read: if isAuthed();
      // Writes only by owner
      allow create, update, delete: if isOwner(uid);
    }

    // Helper function to check if user has access to a folder
    function hasAccessToFolder(uid, folderId) {
      return isOwner(uid) || 
        (exists(/databases/$(database)/documents/shared_items/$(request.auth.uid + '_' + uid + '_' + folderId)) &&
         get(/databases/$(database)/documents/shared_items/$(request.auth.uid + '_' + uid + '_' + folderId)).data.status == 'accepted');
    }

    // Notes: owner or accepted shared recipient can read; only owner edits
    match /users/{uid}/notes/{noteId} {
      allow read: if isOwner(uid) || 
        // Direct note sharing
        (exists(/databases/$(database)/documents/shared_items/$(request.auth.uid + '_' + uid + '_' + noteId)) &&
         get(/databases/$(database)/documents/shared_items/$(request.auth.uid + '_' + uid + '_' + noteId)).data.status == 'accepted');
      allow create, update, delete: if isOwner(uid);
    }

    // Folders: owner can read/write, shared users can read
    match /users/{uid}/folders/{folderId} {
      allow read: if hasAccessToFolder(uid, folderId);
      allow create, update, delete: if isOwner(uid);
    }

    // Handles lookup
    match /handles/{username} {
      allow read: if true;
      allow write: if isAuthed() && request.resource.data.uid == request.auth.uid;
    }

    // Notifications subcollection under users
    // - The user (owner of the user doc) can read/write their own notifications
    // - Any authenticated user can create notifications for other users (for sharing features)
    match /users/{uid}/notifications/{notificationId} {
      allow read: if isOwner(uid);
      allow create: if isAuthed();
      allow update, delete: if isOwner(uid);
    }

    // Shared items with deterministic ID: recipient_owner_item
    match /shared_items/{shareId} {
      // Create rules:
      // 1) Owner can create any share (notes or folders) for a recipient
      // 2) Recipient can create NOTE shares if there's an accepted FOLDER share for the same owner
      allow create: if isAuthed() && (
        (
          // Owner-created share
          request.resource.data.ownerId == request.auth.uid &&
          shareId == (request.resource.data.recipientId + '_' + request.resource.data.ownerId + '_' + request.resource.data.itemId)
        ) || (
          // Recipient-created note share (backfill from accepted folder share)
          request.resource.data.type == 'note' &&
          request.resource.data.recipientId == request.auth.uid &&
          // Ensure the folder share exists and is accepted
          request.resource.data.metadata.fromFolder is string &&
          exists(/databases/$(database)/documents/shared_items/$(request.resource.data.recipientId + '_' + request.resource.data.ownerId + '_' + request.resource.data.metadata.fromFolder)) &&
          get(/databases/$(database)/documents/shared_items/$(request.resource.data.recipientId + '_' + request.resource.data.ownerId + '_' + request.resource.data.metadata.fromFolder)).data.status == 'accepted' &&
          // Enforce deterministic ID for the note share as well
          shareId == (request.resource.data.recipientId + '_' + request.resource.data.ownerId + '_' + request.resource.data.itemId)
        )
      );

      // Allow reads if authenticated and either:
      // - the doc doesn't exist (so clients can check if a share already exists), or
      // - the requester is the owner or the recipient
      allow get: if isAuthed() && (
        !exists(/databases/$(database)/documents/shared_items/$(shareId)) ||
        (resource.data.ownerId == request.auth.uid || resource.data.recipientId == request.auth.uid)
      );
      allow list: if isAuthed();

      // Owner can update permission or status; recipient can update status only
      allow update: if isAuthed() && (
        (resource.data.ownerId == request.auth.uid && request.resource.data.diff(resource.data).changedKeys().hasOnly(['permission','status','updatedAt','expiresAt','message','metadata'])) ||
        (resource.data.recipientId == request.auth.uid && request.resource.data.diff(resource.data).changedKeys().hasOnly(['status','updatedAt']))
      );

      // Owner can always delete; recipient can delete if status is rejected, left, or revoked
      allow delete: if isAuthed() && (
        resource.data.ownerId == request.auth.uid ||
        (resource.data.recipientId == request.auth.uid && 
         resource.data.status in ['rejected', 'left', 'revoked'])
      );
    }

    // Public links: readable by anyone, writable by owner
    match /public_links/{token} {
      allow read: if true;
      allow create, update, delete: if isAuthed() && request.resource.data.ownerId == request.auth.uid;
    }

    // Activity logs: accessible by owner or recipient of the shared item
    match /activity_logs/{logId} {
      allow create: if isAuthed() && request.resource.data.userId == request.auth.uid;
      allow read: if isAuthed() && resource.data.userId == request.auth.uid;
      allow list: if isAuthed();
      allow update, delete: if isAuthed() && resource.data.userId == request.auth.uid;
    }

    // Comments: accessible by owner or participants in the shared item
    match /shared_items/{shareId}/comments/{commentId} {
      allow create: if isAuthed() && exists(/databases/$(database)/documents/shared_items/$(shareId)) && (
        get(/databases/$(database)/documents/shared_items/$(shareId)).data.ownerId == request.auth.uid ||
        get(/databases/$(database)/documents/shared_items/$(shareId)).data.recipientId == request.auth.uid
      );
      allow read, list: if isAuthed() && exists(/databases/$(database)/documents/shared_items/$(shareId)) && (
        get(/databases/$(database)/documents/shared_items/$(shareId)).data.ownerId == request.auth.uid ||
        get(/databases/$(database)/documents/shared_items/$(shareId)).data.recipientId == request.auth.uid
      );
      allow update, delete: if isAuthed() && resource.data.userId == request.auth.uid;
    }

    // Presence: users can write their own presence, anyone authenticated can read
    match /presence/{userId} {
      allow read: if isAuthed();
      allow write: if isAuthed() && userId == request.auth.uid;
    }

    // Global notifications (for backwards compatibility and sharing notifications)
    match /notifications/{notificationId} {
      allow read: if isAuthed() && resource.data.userId == request.auth.uid;
      allow create: if isAuthed() && (
        request.resource.data.userId == request.auth.uid ||
        (
          // Allow creating notifications for shared items participants
          request.resource.data.shareId is string &&
          exists(/databases/$(database)/documents/shared_items/$(request.resource.data.shareId)) &&
          (
            get(/databases/$(database)/documents/shared_items/$(request.resource.data.shareId)).data.ownerId == request.auth.uid ||
            get(/databases/$(database)/documents/shared_items/$(request.resource.data.shareId)).data.recipientId == request.auth.uid
          )
        )
      );
      allow update, delete: if isAuthed() && resource.data.userId == request.auth.uid;
    }
  }
}